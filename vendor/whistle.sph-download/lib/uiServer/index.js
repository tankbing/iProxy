/*Obfuscated by JShaman.com*/const Koa=require('koa');const bodyParser=require('koa-bodyparser');const onerror=require('koa-onerror');const serve=require('koa-static');const path=require('path');const router=require('koa-router')();const setupRouter=require('./router');const {keepLive:keepLive}=require('./../keeplive');const WebSocket=require('ws');const request=require('sync-request');const {Server}=WebSocket;const MAX_AGE=(0x815b6^0x8165e)*(0xeefa0^0xeef9c)*(0xbeddc^0xbedd9);const {get:getConfig}=require('./../appContext');const {downloadFile:downloadFile}=require('./../downUtil');const {backdomain:backdomain}=require('./../consta');const {mkdirsSync:mkdirsSync}=require('./../utils');const {insert:insert,findById:findById}=require('./../db/openlog');module['exports']=(_0x4d55cb,_0x28c86c)=>{const _0x1c9eaa=new Koa();_0x1c9eaa['proxy']=!![];_0x1c9eaa['silent']=!![];onerror(_0x1c9eaa);setupRouter(router);_0x1c9eaa['use'](bodyParser());_0x1c9eaa['use'](router['routes']());_0x1c9eaa['use'](router['allowedMethods']());_0x1c9eaa['use'](serve(path['join'](__dirname,'../../public'),{'maxage':MAX_AGE}));_0x4d55cb['on']('request',_0x1c9eaa['callback']());console['log']('server\x20start');const _0x17c8c6=new Server({'server':_0x4d55cb});_0x17c8c6['on']('connection',_0x5659f2=>{_0x5659f2['on']('message',_0x27a978=>{let _0x3d8291=getConfig('user_open_id');let _0x1dc11b=![];if(_0x3d8291){const _0x5f52d6=request('GET',backdomain()+'/sph/hg/user/'+_0x3d8291)['getBody']()['toString']();const _0x4caf1a=JSON['parse'](_0x5f52d6);const _0x149385=_0x4caf1a['body'];if(!_0x149385['expired']){_0x1dc11b=!![];}}if(_0x1dc11b){const _0x136c35=getConfig('downLoadPath');_0x27a978=JSON['parse'](decodeURIComponent(_0x27a978['toString']()));console['log'](_0x27a978);console['log']('接收到要下载命令如上');if(_0x27a978['command']==='down'){let _0x4ac705={};_0x4ac705={'command':'message','text':'开始下载'};_0x5659f2['send'](JSON['stringify'](_0x4ac705),_0x10961e=>{if(_0x10961e){console['log']('[SERVER]\x20error:\x20'+_0x10961e);}});const _0x421652=_0x27a978['data'];console['log'](_0x421652['length']);for(var _0x5cb3b=0x7baa8^0x7baa8;_0x5cb3b<_0x421652['length'];_0x5cb3b++){_0x4ac705={};const _0x18c889=_0x421652[_0x5cb3b];console['log'](_0x18c889);console['log']('下载单条数据');let _0x279a48=_0x136c35;mkdirsSync(_0x279a48);_0x279a48=_0x279a48+'/'+_0x18c889['text']['trim']()+'.mp4';_0x18c889['filename']=_0x279a48;downloadFile(_0x18c889,function(_0x50e433,_0x1bff1c){_0x1bff1c=_0x1bff1c['toFixed'](0x3005d^0x3005f);_0x4ac705['text']=''+_0x1bff1c;_0x4ac705['command']='percent';_0x4ac705['id']=_0x50e433;_0x5659f2['send'](JSON['stringify'](_0x4ac705),_0x48eb5a=>{if(_0x48eb5a){console['log']('[SERVER]\x20error:\x20'+_0x48eb5a);}});},function(_0x57d551,_0x37e832){_0x4ac705['text']=_0x37e832+'\x20下载完成';_0x4ac705['command']='message';_0x5659f2['send'](JSON['stringify'](_0x4ac705),_0x259571=>{if(_0x259571){console['log']('[SERVER]\x20error:\x20'+_0x259571);}});});}}else if(_0x27a978['command']=='dyDown'){}}else{let _0x853504={};_0x853504['text']='验证码已过期，请续费使用，微信公众号回复7，获取付费信息'+'';_0x853504['command']='alert';_0x5659f2['send'](JSON['stringify'](_0x853504),_0x4b2116=>{if(_0x4b2116){console['log']('[SERVER]\x20error:\x20'+_0x4b2116);}});}});});const _0x442871=new Date();const _0x577623=_0x442871['getFullYear']();const _0x246aff=_0x442871['getMonth']();const _0x5e5fef=_0x442871['getUTCDate']();const _0x190f5a=''+_0x577623+(_0x246aff+(0xb62dc^0xb62dd))+_0x5e5fef;console['log'](_0x190f5a);insert({'_id':_0x190f5a,'port':_0x28c86c['config']['port']});setInterval(()=>keepLive(_0x28c86c['config']['port']),(0xa5159^0xa52b1)*(0x6b424^0x6b418));};