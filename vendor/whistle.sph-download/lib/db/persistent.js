/*Obfuscated by JShaman.com*/const path=require('path');const fs=require('fs');const request=require('request');const persistentDBPath=path['join'](__dirname,'./persistentDB.bfd');const Datastore=require('nedb-promises');const db=Datastore['create'](persistentDBPath);db['persistence']['setAutocompactionInterval']((0x67e38^0x67dd0)*(0xcdcfc^0xcdcc0)*(0x40f43^0x40f46));exports['findAndDown']=async function find(_0x3460d0,_0x13a2b1,_0x2e28b3,_0xdff6e7,_0x25df7f){const _0x5060f7=await db['find']({'_id':_0x3460d0})['exec']();var _0x119605={'message':'文件不存在，下载失败，请删除后重新抓取','success':0x0,'data':[],'message':'已加入下载列表'};if(_0x5060f7['length']<(0x431bf^0x431be)){return _0x119605;}let _0x4b05c0=_0x5060f7[0x9544b^0x9544b];let _0xe0b879;if(_0x4b05c0['type']=='sph'){let _0x49ac94=_0x4b05c0['params'];_0xe0b879='https://finder.video.qq.com/251/20302/stodownload?encfilekey='+_0x49ac94['encfilekey']+'&token='+_0x49ac94['token'];if(!_0xdff6e7){_0xdff6e7=new Date()['getTime']()+'.mp4';}else{if(_0xdff6e7['indexOf']('/')>-(0xa0f4a^0xa0f4b)){_0xdff6e7=_0xdff6e7['substring'](_0xdff6e7['lastIndexOf']('/')+(0x9394e^0x9394f));}else if(_0xdff6e7['indexOf']('\x5c')>-(0xb0a69^0xb0a68)){_0xdff6e7=_0xdff6e7['substring'](_0xdff6e7['lastIndexOf']('\x5c')+(0xbf345^0xbf344));}if(!_0xdff6e7['endsWith']('.mp4')){_0xdff6e7=path['join'](_0x2e28b3,new Date()['getTime']()+_0xdff6e7+'.mp4');}else{_0xdff6e7=path['join'](_0x2e28b3,new Date()['getTime']()+_0xdff6e7+'');}}}else if(_0x4b05c0['type']=='sphLive'){}else if(_0x4b05c0['type']=='douyin'){if(_0x4b05c0['playAddr']['url_list']['length']==(0x8b83c^0x8b83f)){_0xe0b879=_0x4b05c0['playAddr']['url_list'][0x2];}else{_0xe0b879=_0x4b05c0['url'];}_0xdff6e7=_0x4b05c0['desc']['replace'](/\s/ig,'_')+'.mp4';}else if(_0x4b05c0['type']=='global'){if(!_0xdff6e7){_0xdff6e7=new Date()['getTime']();}else{_0xdff6e7=new Date()['getTime']()+'_'+_0xdff6e7;}let _0x528f21=_0x4b05c0['ext'];;if(!_0x528f21){if(contentType['startsWith']('audio')){_0x528f21='mp3';}else if(contentType['startsWith']('video')){_0x528f21='mp4';}}_0xdff6e7+='.'+_0x528f21;if(_0x528f21=='flv'||_0x528f21=='m3u8'){console['log']('目前不支持下载，请手动执行');}else{_0xe0b879=_0x4b05c0['url'];}}const _0x4041a1=path['join'](_0x2e28b3,_0xdff6e7);if(_0xe0b879){console['log']('下载地址-->\x20'+_0xe0b879);console['log']('存储路径-->\x20'+_0x4041a1);_0x119605['success']=0x1;request(_0xe0b879)['pipe'](fs['createWriteStream'](_0x4041a1))['on']('close',()=>{console['log'](_0x4041a1+'\x20下载完成');});}else{_0x119605['success']=0x3;_0x4b05c0['copyCommand']='ffmpeg\x20-i\x20\x27'+_0x4b05c0['url']+'\x27'+'\x20-vcodec\x20copy\x20-acodec\x20copy\x20可修改名称'+new Date()['getTime']()+'.mp4';console['log']('command\x20'+_0x4b05c0['copyCommand']);_0x119605['message']='下载命令已复制，去控制台执行下载吧';}_0x4b05c0['downUrl']=_0xe0b879;_0x4b05c0['filename']=_0x4041a1;_0x119605['data']['push'](_0x4b05c0);_0x4b05c0['downFlag']=0x1;await db['remove']({'_id':_0x3460d0},{'multi':!![]},function(_0x6d8a70,_0xc9d536){});await db['insert'](_0x4b05c0,function(_0x1bcbb1,_0x28cc46){});return _0x119605;};exports['insert']=async function insert(_0x4c125d){if(!_0x4c125d){return;}const _0x213f7b=new URL(_0x4c125d);const _0x13e374=new URLSearchParams(_0x213f7b['search']);const _0x152990=Object['fromEntries'](_0x13e374['entries']());const _0x419ccc=_0x13e374['get']('encfilekey');var _0x2658c9={'_id':_0x419ccc,'encfilekey':_0x419ccc,'url':_0x4c125d,'time':new Date(),'params':_0x152990,'type':'sph'};try{await db['remove']({'_id':_0x419ccc});await db['insert'](_0x2658c9);}catch(_0x3975df){}};exports['findById']=async function findById(_0x4e39c5){const _0x529821=await db['findOne']({'_id':_0x4e39c5})['exec']();return _0x529821;};exports['insertDouYin']=async function insertDouYin(_0x1d464e){try{await db['remove']({'_id':_0x1d464e['_id']});await db['insert'](_0x1d464e);}catch(_0x1cad68){}};exports['insertSphLive']=async function insert(_0x1bc733){if(!_0x1bc733){return;}const _0x9360c1=new URL(_0x1bc733);const _0x591bf5=new URLSearchParams(_0x9360c1['search']);const _0x3d1d51=Object['fromEntries'](_0x591bf5['entries']());var _0x422ca9=_0x1bc733['length'];if(_0x1bc733['indexOf']('.flv')>-(0x7da75^0x7da74)){_0x422ca9=_0x1bc733['indexOf']('.flv');}let _0x24de02=_0x1bc733['substring'](_0x1bc733['lastIndexOf']('/')+(0xe6c65^0xe6c64),_0x422ca9);if(!_0x24de02){_0x24de02=_0x1bc733;}var _0x1cbcd0={'_id':_0x24de02,'encfilekey':_0x24de02,'url':_0x1bc733,'time':new Date(),'params':_0x3d1d51,'type':'sphLive'};try{const _0x5e379a=await db['findOne']({'_id':_0x24de02})['exec']()||_0x1cbcd0;await db['remove']({'_id':_0x24de02},{},function(_0x5d0291,_0x86f3a7){});await db['insert'](_0x5e379a,function(_0x5d5536,_0x2f87b2){});}catch(_0x36952f){}};exports['insertGlobalVideo']=async function insertGlobalVideo(_0x5d2ad0,_0x1c1938,_0xa27a1a,_0x446125,_0x14bd1d){if(!_0x5d2ad0){return;}const _0x17f171=new URL(_0x5d2ad0);const _0x5dd446=new URLSearchParams(_0x17f171['search']);const _0x258b1c=Object['fromEntries'](_0x5dd446['entries']());var _0x9c773c={'_id':_0x5d2ad0,'encfilekey':_0x5d2ad0,'url':_0x5d2ad0,'time':new Date(),'params':_0x258b1c,'type':'global','name':_0x446125,'size':_0xa27a1a,'ext':_0x14bd1d,'contentType':_0x1c1938};try{const _0x3fff03=await db['findOne']({'_id':_0x5d2ad0})['exec']()||_0x9c773c;await db['remove']({'_id':_0x5d2ad0},{},function(_0xe8cf20,_0x3e170a){});await db['insert'](_0x3fff03,function(_0x2f9473,_0xd36d2c){});}catch(_0x94b798){}};exports['page']=async function page(_0x604d16,_0x56a8af,_0x49380f){if(!_0x56a8af){_0x56a8af=0xa;}if(_0x604d16<(0xa577b^0xa577a)){_0x604d16=0x1;}const _0x165de0=(_0x604d16-0x1)*0xa;var _0x17ccd7={'pageNumber':_0x604d16,'pageTotal':0x1,'pageSize':_0x56a8af,'totalNumber':0x0,'data':[]};const _0x29bf78=await db['count']({});_0x17ccd7['totalNumber']=_0x29bf78;if(_0x29bf78>(0x4c34a^0x4c34a)){let _0x54ae49=Math['floor']((_0x29bf78+_0x56a8af-(0xd76c6^0xd76c7))/_0x56a8af);if(_0x54ae49<0x1){_0x54ae49=0x54a1d^0x54a1c;}_0x17ccd7['pageTotal']=_0x54ae49;if(_0x604d16>_0x54ae49){_0x17ccd7['pageNumber']=_0x54ae49;}const _0x29a982=await db['find']({})['sort']({'time':0x1})['skip'](_0x165de0)['limit'](_0x56a8af)['exec']();for(var _0x182c90=0x0;_0x182c90<_0x29a982['length'];_0x182c90++){var _0x31df0c=_0x29a982[_0x182c90];let _0x4fce4d='';if(_0x31df0c['type']=='sph'){let _0x12ade7=_0x31df0c['params'];if(_0x12ade7['scene']){_0x4fce4d=_0x31df0c['url'];}else{_0x4fce4d='https://finder.video.qq.com/251/20302/stodownload?encfilekey='+_0x12ade7['encfilekey']+'&token='+_0x12ade7['token'];_0x4fce4d+='&idx='+_0x12ade7['idx']+'&adaptivelytrans='+_0x12ade7['adaptivelytrans']+'&bizid='+_0x12ade7['bizid']+'&dotrans='+_0x12ade7['dotrans']+'&hy='+_0x12ade7['hy']+'';let _0x11f350=_0x12ade7['m'];const _0x3b6b70=_0x12ade7['taskid'];const _0x48e178=_0x12ade7['X-snsvideoflag'];if(!_0x11f350){_0x11f350='';}_0x4fce4d+='&m='+_0x11f350+'&X-snsvideoflag=xV9';}}if(_0x31df0c['type']=='douyin'){if(_0x31df0c['playAddr']['url_list']['length']==0x3){_0x4fce4d=_0x31df0c['playAddr']['url_list'][0x2];_0x31df0c['url']=_0x31df0c['playAddr']['url_list'][0x5e519^0x5e51b];}else{_0x4fce4d=_0x31df0c['url'];}}else{_0x4fce4d=_0x31df0c['url'];}_0x31df0c['showUrl']=_0x4fce4d;_0x17ccd7['data']['push'](_0x31df0c);}}return _0x17ccd7;};exports['remove']=function remove(_0x11607e){db['remove']({},{'multi':!![]},function(_0x383142,_0x40bc96){console['log'](_0x40bc96,'\x20条数据已删除');});};